KISSY.add("kg/personality/0.0.8/index",["io","json","node","promise","offline","reporter","tms/xtemplate"],function(e,t,a,n){var r,i,s=t("io"),o=t("json"),u=t("node"),d=t("promise"),l=t("offline"),c=t("reporter"),h=t("tms/xtemplate");r=function(t){function a(e){for(var t in e)this[t]=e[t];this.init()}function n(t){var a=e.lastIndexOf(t,"."),n=t.slice(0,a);return n}var r=s,i=o,m=u,f=d,p=l,g=c,v=h,R=window.HubCache=window.HubCache||{},_="//tce.alicdn.com/api/data.htm",b="https://tui.taobao.com/recommend",C=new p,k=m.all;return a.prototype={init:function(){var e=this;this.el=k(e.box),this.index=this.el.attr("data-index"),this.moduleName=this.el.attr("data-name"),this.backupName="tbh-"+this.moduleName,this.mConfig=this.el.one("textarea").val(),this.len=+this.el.one(e.contain).attr("data-len"),this.closePer="1"===this.el.one(e.contain).attr("data-close-per");try{this.mConfig=i.parse(this.mConfig),R["mconfig_"+e.moduleName]=this.mConfig,this.requestPerData()}catch(t){g.send({category:"ERROR_Blocks_fatal_err",msg:"\u6a21\u5757 "+e.moduleName+" \u914d\u7f6e\u6587\u4ef6"})}},checkConfig:function(){for(var e=this.mConfig,t=0,a=0,n=e.length;a<n;a++)e[a].per!==!1&&"false"!==e[a].per||t++;return t<e.length},requestPerData:function(){var e=this,t=window.location.search,a=t&&KISSY.unparam(t.slice(1)).hasOwnProperty("_edit");if(a)return g.send({msg:"\u6a21\u5757 "+e.moduleName+" \u4e2a\u6027\u5316\u901a\u8fc7 `_edit` \u53c2\u6570\u5173\u95ed"},"warn"),void e.pureRequest();if(e.closePer)return void e.pureRequest();if(!this.checkConfig())return void this.pureRequest();var n="tpp_"+e.moduleName;r({scriptCharset:"gbk",url:b,timeout:4,dataType:"jsonp",data:{appid:KISSY.isArray(e.appids)?e.appids[e.index-1]:e.appids}}).then(function(t){var a=t[0];if(R[n]=a,!(a&&a.result&&a.result.length>=e.len))return g.send({category:"ERROR_Blocks_Per_Data_err",msg:"\u6a21\u5757 "+e.moduleName+" \u4e2a\u6027\u5316\u63a5\u53e3\u8bf7\u6c42\u6570\u636e\u683c\u5f0f\u4e0d\u6b63\u786e\u6216\u8005\u6570\u76ee\u4e0d\u8db3,\u8d70\u9ed8\u8ba4\u914d\u7f6e\u65b9\u6848"}),void e.pureRequest();for(var r=0,i=0,s=a.result.length;i<s;i++)for(var o=a.result[i].productId,u=0,d=e.mConfig.length;u<d;u++)if(o==e.mConfig[u].uid){r++;break}if(r<e.len)return g.send({category:"ERROR_PER_REQUEST_ERR",msg:"\u6a21\u5757 "+e.moduleName+" \u4e2a\u6027\u5316\u63a5\u53e3\u4e2d\u90e8\u5206 uid \u6570\u636e\u4e0d\u5b58\u5728, \u8d70\u9ed8\u8ba4\u914d\u7f6e\u65b9\u6848"}),void e.pureRequest();var l=e._resolvePerData(a);return l.length<e.len?(g.send({category:"WARN_PER_REQUEST_ERR",msg:"\u7ecf\u8fc7\u4e0e mConfig \u5339\u914d\u540e,\u6a21\u5757 "+e.moduleName+" \u4e2a\u6027\u5316\u63a5\u53e3\u6570\u636e\u8fc7\u5c11,\u8d70\u9ed8\u8ba4\u914d\u7f6e\u65b9\u6848"}),void e.pureRequest()):void e.requestModuleData(l).then(function(){e.render()})}).fail(function(){g.send({category:"WARN_PER_REQUEST_ERR",msg:"\u6a21\u5757 "+e.moduleName+" \u4e2a\u6027\u5316\u63a5\u53e3\u8bf7\u6c42\u5931\u8d25,\u8d70\u9ed8\u8ba4\u914d\u7f6e\u65b9\u6848"}),e.pureRequest()})},_resolvePerData:function(e){var t=this;t.data=[];var a=[];e=e.result;for(var n=0,r=e.length;n<r;n++)for(var i=e[n].productId,s=0,o=t.mConfig.length;s<o;s++){var u=t.mConfig[s];if(u.uid==i){var d=KISSY.merge(u,{pData:e[n]});t.data.push(d),a.push(u.mid);break}}return a.sort(function(e,t){return e-t>0?1:-1})},requestModuleData:function(e){var t=this,a="tce_"+this.moduleName+"_"+e.join("_");return this.fetch(a,e).then(function(e){R[a]=e;for(var n=t.data,r=0,i=n.length;r<i;r++){var s=n[r].mid;n[r].mData=e[s]}return t.data=n,n})},fetch:function(e,t){var a=this;return this.tce(e,t).then(function(e){return e},function(){var e=C.getItem("cache-blocks-"+a.moduleName);return e?(a.send("\u6a21\u5757 "+a.moduleName+" \u5f02\u5e38\uff0c\u8d70\u672c\u5730\u7f13\u5b58"),e=i.parse(e)):a.backup()})},tce:function(e,t){var a=this;return new f(function(n,s){r({url:_,timeout:8,dataType:"jsonp",jsonpCallback:e,cache:!0,data:{ids:t.join(",")},success:function(e){var t=!0;for(var r in e)e[r]&&e[r].value||(t=!1);t?(C.setItem("cache-blocks-"+a.moduleName,i.stringify(e)),n(e)):s()},error:function(){s()}})})},backup:function(){var t=this;return new f(function(a,n){e.use(["p/"+t.backupName+"/index"],function(e,n){t.send("\u6a21\u5757 "+t.moduleName+" \u5f02\u5e38\uff0c\u8d70 cdn"),a(n)},function(e){t.send("\u6a21\u5757 "+t.moduleName+" \u5929\u7a97, cdn\u4e5f\u5f02\u5e38\u4e86"),n()})})},send:function(e){g.send({category:"ERROR_Blocks_fatal_err",msg:e},"warn")},pureRequest:function(){for(var e=this,t=[],a=[],n=[],r=0,i=this.mConfig.length;r<i;r++){var s=this.mConfig[r].backup;"true"==s||1==s?a.push(this.mConfig[r]):n.push(this.mConfig[r])}this.data=a.concat(n),KISSY.each(this.data,function(e){t.push(e.mid)}),t.length>=this.len&&(t.length=this.len),e.requestModuleData(t,"PURE").then(function(){e.render("PURE")})},render:function(t){var a=this,r="";if(this.data.length>=a.len?this.data.length=a.len:g.send({category:"WARN_Blocks_data_less",msg:"\u6a21\u5757 "+a.moduleName+" \u6e32\u67d3\u65f6\u53d1\u73b0\u6570\u636e\u8fc7\u5c11"}),!this.data.length)return void g.send({category:"ERR_Blocks_data_null",msg:"\u6a21\u5757 "+a.moduleName+" \u6e32\u67d3\u65f6\u53d1\u73b0\u6570\u636e\u4e3a\u7a7a,\u5929\u7a97"},"warn");var i=[],s=[];if(i.length=this.len,t){for(var o=0,u=this.data.length;o<u;o++){var d=this.data[o].baseid;d?i[d-1]=this.data[o]:s.push(this.data[o])}for(var l=0,c=i.length;l<c;l++)i[l]&&i[l].baseid||(i[l]=s.shift())}else i=this.data;KISSY.each(i,function(e,n){var i=e.tid?a.xtplFun[e.tid-1]:a.xtplFun,s=new v(i),o=KISSY.merge(e.mData.value,{spmab:e.uid,baseid:e.baseid,backup:e.backup,mid:e.mid,index:n});t||"true"!=e.per&&1!=e.per||a.renderCallback&&a.renderCallback(o,e),r+=s.render(o)}),a.el.on("M:load",function(){var t=window.HubCache&&window.HubCache["tpp_"+a.moduleName];if(t){var r=t.pvid,i=t.scm;if(r&&i){var s="pvid="+r+"&scm="+i;a.el.all("a").each(function(t){var r=k(t),o=r.attr("href");if(o&&o.indexOf("//")>-1){var u=o.split("#")[1];o=o.split("#")[0];try{var d=o.split("?")[1];if(d){var l=e.unparam(d,"&").scm;if(l){var c=(n(l),n(i));if(c===c)return}}}catch(h){g.send({category:"WARN_Blocks_scm_error",msg:"\u6a21\u5757 "+a.moduleName+" SCM \u57cb\u70b9\u65f6\u53d1\u751f\u9519\u8bef"})}if(o=o.replace(/(scm|pvid)=.*?(&|$)/gm,""),o.indexOf("?")>-1){var m=o.split("?");o=m[0]+"?"+(m[1]?m[1]+"&"+s:s)}else o=o+"?"+s;o+=u?"#"+u:"",k(t).attr("href",o)}})}}}),a.bindCallback&&a.bindCallback(this,r)}},a}(),i=function(e){return e=r}(),n.exports=i});